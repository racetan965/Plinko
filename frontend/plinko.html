<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Plinko Racetan</title>

<style>
    body {
        margin: 0;
        padding: 0;
        background: #0a0f24;
        font-family: "Cairo", sans-serif;
        color: #fff;
        text-align: center;
    }

    .container {
        max-width: 460px;
        margin: 0 auto;
        padding: 20px;
    }

    h1 {
        color: #ff69b4;
        margin-bottom: 15px;
        letter-spacing: 2px;
    }

    .stats-box {
        display: flex;
        justify-content: space-between;
        margin-bottom: 16px;
    }

    .card {
        background: #0f172a;
        padding: 14px;
        border-radius: 14px;
        border: 1px solid #38bdf8;
        width: 48%;
    }

    .label {
        color: #94a3b8;
        font-size: 14px;
        margin-bottom: 6px;
    }

    .value {
        font-size: 22px;
        font-weight: bold;
        color: #fff;
    }

    #connecting {
        margin: 10px 0;
        color: #a5f3fc;
        font-size: 14px;
    }

    .game-board {
        width: 100%;
        height: 420px;
        background: #08101d;
        border-radius: 20px;
        margin: 18px 0;
        padding-top: 12px;
        position: relative;
        overflow: hidden;
    }

    canvas {
        width: 100%;
        height: 100%;
    }

    .controls {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
    }

    button {
        width: 48%;
        padding: 12px;
        border: none;
        border-radius: 12px;
        font-size: 18px;
        cursor: pointer;
        font-weight: bold;
        color: #fff;
    }

    #dropBtn {
        background: linear-gradient(135deg, #22c55e, #4ade80);
    }

    #cashoutBtn {
        background: linear-gradient(135deg, #f97316, #fb923c);
    }

    #bets {
        display: flex;
        justify-content: center;
        margin-top: 16px;
        gap: 10px;
    }

    .bet-btn {
        padding: 10px 14px;
        border-radius: 10px;
        background: #1e293b;
        border: 1px solid #475569;
        cursor: pointer;
        color: #fff;
        font-weight: 600;
        font-size: 15px;
    }

    /* Toast */
    #toast {
        display: none;
        position: fixed;
        bottom: 25px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        padding: 14px 20px;
        border-radius: 12px;
        color: #fff;
        font-size: 15px;
        z-index: 9999;
    }
</style>
</head>

<body>
<div class="container">

    <h1>PLINKO RACETAN</h1>

    <div class="stats-box">
        <div class="card">
            <div class="label">الرصيد الحالي</div>
            <div class="value" id="balanceValue">0.00 دك</div>
        </div>
        <div class="card">
            <div class="label">الكرات المستخدمة</div>
            <div class="value" id="ballsValue">0 كرة</div>
        </div>
    </div>

    <div id="connecting">جارِ الاتصال بالسيرفر...</div>

    <div id="bets">
        <button class="bet-btn" onclick="setBet(1)">1 دك</button>
        <button class="bet-btn" onclick="setBet(2)">+1 دك</button>
        <button class="bet-btn" onclick="setBet(5)">+5 دك</button>
    </div>

    <div class="game-board">
        <canvas id="plinkoCanvas"></canvas>
    </div>

    <div class="controls">
        <button id="cashoutBtn" onclick="handleCashout()">كــاش آوت</button>
        <button id="dropBtn" onclick="handleDrop()">نزل الكرة</button>
    </div>

</div>

<div id="toast"></div>

<script>
/* =============================
      CONNECTION + SESSION
============================= */

// أقرأ session_token من LocalStorage
const session_token = localStorage.getItem("session_token");

if (!session_token) {
    window.location.href = "/";
}

let balance = 0;
let ballsPlayed = 0;
let stakePerBall = 1;

// Toast
function showToast(msg, duration = 2000) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.style.display = "block";
    setTimeout(() => t.style.display = "none", duration);
}

// تحديث الواجهة
function updateUI() {
    document.getElementById("balanceValue").innerText = balance.toFixed(3) + " دك";
    document.getElementById("ballsValue").innerText = ballsPlayed + " كرة";
}

// إخفاء "جاري الاتصال"
function hideConnecting() {
    const el = document.getElementById("connecting");
    if (el) el.style.display = "none";
}

// تغيير قيمة الرهان
function setBet(v) {
    stakePerBall = v;
    showToast(`قيمة الرهان: ${v} دك`);
}

/* =============================
          API CALLS
============================= */

async function initSession() {
    try {
        const res = await fetch("/api/init-session", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ session_token })
        });

        const data = await res.json();

        if (!data.ok) {
            showToast("خطأ في الجلسة");
            return;
        }

        balance = data.balance;
        ballsPlayed = data.balls_played;

        updateUI();
        hideConnecting();

    } catch (err) {
        showToast("خطأ اتصال بالسيرفر");
    }
}

async function apiDrop() {
    try {
        const res = await fetch("/api/drop", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                session_token,
                stake: stakePerBall
            })
        });
        const data = await res.json();

        if (!data.ok) {
            showToast(data.detail || "خطأ أثناء إسقاط الكرة");
            return null;
        }

        balance = data.balance;
        ballsPlayed = data.balls_played;
        updateUI();

        return data;

    } catch (err) {
        showToast("مشكلة اتصال");
        return null;
    }
}

async function apiCashout() {
    try {
        const res = await fetch("/api/cashout", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ session_token })
        });

        const data = await res.json();

        if (!data.ok) {
            showToast("لم يتم الكاش آوت");
            return;
        }

        balance = data.balance;
        updateUI();

        showToast("تم الكاش آوت!");
    } catch (err) {
        showToast("خطأ اتصال");
    }
}

/* =============================
            ACTIONS
============================= */

async function handleDrop() {
    const result = await apiDrop();
    if (!result) return;
    
    // تشغيل صوت
    playSoundDrop();

    // إضافة الحركة
    launchBallAnimation(result.multiplier);
}

function handleCashout() {
    apiCashout();
}

/* =============================
          SOUNDS
============================= */

const sndDrop = new Audio("/sounds/drop.mp3");
const sndSmall = new Audio("/sounds/land_small.mp3");
const sndZero = new Audio("/sounds/land_zero.mp3");
const sndBig = new Audio("/sounds/big_win.mp3");

function playSoundDrop() { sndDrop.play(); }
function playSmall() { sndSmall.play(); }
function playZero() { sndZero.play(); }
function playBig() { sndBig.play(); }

/* =============================
      SIMPLE BALL ANIMATION
============================= */

const canvas = document.getElementById("plinkoCanvas");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
}
resizeCanvas();

function launchBallAnimation(multiplier) {
    let y = 0;
    const x = canvas.width / 2;

    const interval = setInterval(() => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // draw ball
        ctx.beginPath();
        ctx.arc(x, y, 10, 0, Math.PI * 2);
        ctx.fillStyle = "#4ade80";
        ctx.fill();

        y += 8;

        if (y > canvas.height - 40) {
            clearInterval(interval);

            if (multiplier === 0) playZero();
            else if (multiplier <= 5) playSmall();
            else playBig();

            showToast(`ربحت ${multiplier}x`);
        }
    }, 16);
}

/* =============================
         START APP
============================= */

initSession();

</script>

</body>
</html>
