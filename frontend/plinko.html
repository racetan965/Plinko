<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plinko Racetan</title>

  <!-- Matter.js Ù…Ù† CDN -->
  <script src="https://cdn.jsdelivr.net/npm/matter-js@0.20.0/build/matter.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: "Cairo", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0%, #020617 35%, #000 100%);
      color: #e5e7eb;
    }
    .wrapper {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 20px 12px 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .panel {
      width: 100%;
      background: linear-gradient(145deg, #020617, #020617);
      border-radius: 26px;
      padding: 18px 16px 20px;
      border: 1px solid rgba(56,189,248,0.5);
      box-shadow: 0 20px 60px rgba(15,23,42,0.8);
    }
    h1 {
      margin: 0 0 6px;
      font-size: 22px;
      letter-spacing: 2px;
      text-align: center;
      color: #f472b6;
    }
    .subtitle {
      text-align: center;
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 12px;
    }
    .stats-row {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
    }
    .stat-card {
      flex: 1;
      background: radial-gradient(circle at top left, #0b1120, #020617);
      border-radius: 18px;
      border: 1px solid #1d4ed8;
      padding: 10px 10px 8px;
    }
    .stat-label {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .stat-value {
      font-size: 18px;
      font-weight: 700;
      color: #f9fafb;
    }
    #connecting {
      font-size: 12px;
      color: #a5f3fc;
      margin-bottom: 8px;
      text-align: center;
    }
    .bet-row {
      display: flex;
      gap: 8px;
      margin: 8px 0 10px;
      justify-content: center;
    }
    .bet-btn {
      flex: 1;
      background: #020617;
      border-radius: 999px;
      border: 1px solid #475569;
      padding: 7px 0;
      font-size: 13px;
      cursor: pointer;
      color: #e5e7eb;
      font-weight: 600;
    }
    .bet-btn.active {
      border-color: #22c55e;
      background: radial-gradient(circle at top, #16a34a, #166534);
    }
    .plinko-shell {
      margin-top: 4px;
      border-radius: 24px;
      padding: 10px 10px 0;
      background: radial-gradient(circle at top, #020617, #020617 40%, #020617 70%, #000 100%);
      border: 1px solid rgba(148,163,184,0.3);
    }
    #plinko-container {
      width: 100%;
      height: 360px;
      border-radius: 18px;
      overflow: hidden;
      position: relative;
      background: radial-gradient(circle at top, #0f172a, #020617 60%, #000 100%);
    }
    .bins-row {
      display: grid;
      grid-template-columns: repeat(16, minmax(0,1fr));
      gap: 1px;
      margin-top: 8px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #1f2937;
    }
    .bin-slot {
      padding: 4px 0 3px;
      font-size: 10px;
      font-weight: 800;
      color: #f9fafb;
      text-align: center;
    }
    .bin-small { background:#1d4ed8; }
    .bin-mid { background:#0f766e; }
    .bin-bad { background:#7f1d1d; }
    .bin-zero { background:#020617; color:#9ca3af; }
    .controls-row {
      display: flex;
      gap: 10px;
      margin-top: 14px;
    }
    .btn-main {
      flex: 1;
      padding: 11px 8px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 700;
      color: #0f172a;
    }
    #dropBtn {
      background: linear-gradient(135deg, #22c55e, #4ade80);
    }
    #dropBtn:disabled {
      opacity: 0.5;
      cursor: default;
    }
    #cashoutBtn {
      background: linear-gradient(135deg, #f97316, #fb923c);
    }
    #cashoutBtn:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .footer {
      margin-top: 10px;
      font-size: 11px;
      color: #9ca3af;
      text-align: center;
    }
    #toast {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: #f9fafb;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 13px;
      z-index: 9999;
      max-width: 90%;
    }
  </style>
</head>

<body>
<div class="wrapper">
  <div class="panel">
    <h1>PLINKO RACETAN</h1>
    <div class="subtitle">
      Ø±ØµÙŠØ¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù¥ Ø¯Ùƒ â€” ÙƒÙ„ ÙƒØ±Ø© ØªÙ†Ø²Ù„ Ø­Ø³Ø¨ Ø±Ù‡Ø§Ù†ÙƒØŒ ÙˆØ§Ù„Ø¬Ø§Ø¦Ø²Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¶Ø§Ø¹ÙÙ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„.
    </div>

    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
        <div class="stat-value" id="balanceValue">0.000 Ø¯Ùƒ</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Ø§Ù„ÙƒØ±Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©</div>
        <div class="stat-value" id="ballsValue">0 ÙƒØ±Ø©</div>
      </div>
    </div>

    <div id="connecting">Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...</div>

    <div class="bet-row">
      <button class="bet-btn active" data-bet="1">Ù¡ Ø¯Ùƒ</button>
      <button class="bet-btn" data-bet="2">Ù¢ Ø¯Ùƒ</button>
      <button class="bet-btn" data-bet="5">Ù¥ Ø¯Ùƒ</button>
    </div>

    <div class="plinko-shell">
      <div id="plinko-container"></div>
      <div class="bins-row" id="binsRow"></div>
    </div>

    <div class="controls-row">
      <button id="cashoutBtn" class="btn-main" onclick="handleCashout()">ÙƒÙ€Ù€Ø§Ø´ Ø¢ÙˆØª</button>
      <button id="dropBtn" class="btn-main" onclick="handleDrop()">Ù†Ø²Ù„ Ø§Ù„ÙƒØ±Ø©</button>
    </div>

    <div class="footer">
      Ø£ÙŠ ØªÙ„Ø§Ø¹Ø¨ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ù„Ù„ØµÙØ­Ø© Ù„Ø§ ÙŠØ¹Ø·ÙŠ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù†ÙØ³ Ø§Ù„Ø­Ø³Ø§Ø¨.
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
/* =======================
    SESSION & GLOBALS
======================= */
const session_token = localStorage.getItem("session_token");
if (!session_token) {
  window.location.href = "/";
}

const username = localStorage.getItem("username") || "Ù„Ø§Ø¹Ø¨";

let balance = 0;
let ballsPlayed = 0;
let stakePerBall = 1;
let cashedOut = false;
let finished = false;

// multipliers Ø¹Ù„Ù‰ Ø§Ù„ØªØ±ØªÙŠØ¨ Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ù„ÙŠÙ…ÙŠÙ† (16 Ø®Ø§Ù†Ø©)
const BIN_MULTIPLIERS = [1000, 50, 25, 10, 5, 2, 1, 0, 0, 1, 2, 5, 10, 25, 50, 1000];

const toastEl = document.getElementById("toast");
const connectingEl = document.getElementById("connecting");
const balanceEl = document.getElementById("balanceValue");
const ballsEl = document.getElementById("ballsValue");
const dropBtn = document.getElementById("dropBtn");
const cashoutBtn = document.getElementById("cashoutBtn");

/* =======================
          TOAST
======================= */
function showToast(msg, ms=2200) {
  toastEl.textContent = msg;
  toastEl.style.display = "block";
  setTimeout(() => { toastEl.style.display = "none"; }, ms);
}

/* =======================
      UPDATE UI
======================= */
function updateUI() {
  balanceEl.textContent = balance.toFixed(3) + " Ø¯Ùƒ";
  ballsEl.textContent = ballsPlayed + " ÙƒØ±Ø©";
  if (cashedOut || finished) {
    dropBtn.disabled = true;
    cashoutBtn.disabled = true;
  }
}
function hideConnecting() {
  if (connectingEl) connectingEl.style.display = "none";
}

/* =======================
         BET BUTTONS
======================= */
document.querySelectorAll(".bet-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".bet-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    stakePerBall = parseFloat(btn.dataset.bet);
    showToast("Ù‚ÙŠÙ…Ø© Ø§Ù„Ø±Ù‡Ø§Ù†: " + stakePerBall.toFixed(0) + " Ø¯Ùƒ", 1500);
  });
});

/* =======================
         BINS UI
======================= */
const binsRow = document.getElementById("binsRow");
BIN_MULTIPLIERS.forEach(m => {
  const div = document.createElement("div");
  div.classList.add("bin-slot");
  if (m === 0) div.classList.add("bin-zero");
  else if (m <= 5) div.classList.add("bin-small");
  else if (m <= 25) div.classList.add("bin-mid");
  else div.classList.add("bin-bad");
  div.textContent = m + "x";
  binsRow.appendChild(div);
});

/* =======================
        API CALLS
======================= */
async function initSession() {
  try {
    const res = await fetch("/api/init-session", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ session_token })
    });
    const data = await res.json();
    if (!data.ok) {
      showToast("Ù„Ù… ÙŠØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¬Ù„Ø³Ø©");
      return;
    }
    balance = data.balance;
    ballsPlayed = data.balls_played;
    cashedOut = data.cashed_out;
    finished = data.finished;
    updateUI();
    hideConnecting();
  } catch (e) {
    showToast("Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
  }
}

async function apiDrop() {
  try {
    const res = await fetch("/api/drop", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ session_token, stake: stakePerBall })
    });
    const data = await res.json();
    if (!res.ok || !data.ok) {
      const msg = data.detail || data.error || "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø³Ù‚Ø§Ø· Ø§Ù„ÙƒØ±Ø©";
      showToast(msg);
      if ((data.detail && data.detail.includes("Ù…Ù†ØªÙ‡ÙŠØ©")) || (data.detail && data.detail.includes("Ø§Ù„ÙƒØ§Ø´"))) {
        cashedOut = true;
        finished = true;
        updateUI();
        goToResult();
      }
      dropBtn.disabled = false;
      return null;
    }
    balance = data.balance;
    ballsPlayed = data.balls_played;
    cashedOut = data.cashed_out;
    finished = data.finished;
    updateUI();
    return data;
  } catch (e) {
    showToast("Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„");
    dropBtn.disabled = false;
    return null;
  }
}

async function apiCashout() {
  try {
    const res = await fetch("/api/cashout", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ session_token })
    });

    const data = await res.json();

    if (!res.ok || !data.ok) {
      const msg = data.detail || data.error || "Ù„Ù… ÙŠØªÙ… Ø§Ù„ÙƒØ§Ø´ Ø¢ÙˆØª";
      showToast(msg);
      return;
    }

    balance = data.balance;
    cashedOut = data.cashed_out;
    finished = data.finished;
    updateUI();

    // ğŸ”¥ ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ÙƒØ§Ø´ Ø¢ÙˆØª
    sndCashout.currentTime = 0;
    sndCashout.play().catch(()=>{});

    showToast("ØªÙ… Ø§Ù„ÙƒØ§Ø´ Ø¢ÙˆØª!");

    // ØªØ­ÙˆÙŠÙ„ Ù„ØµÙØ­Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø©
    goToResult();

  } catch (e) {
    showToast("Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØ§Ø´ Ø¢ÙˆØª");
  }
}


/* =======================
       RESULT PAGE
======================= */
function goToResult() {
  const url = `/result.html?name=${encodeURIComponent(username)}&balance=${balance.toFixed(3)}&balls=${ballsPlayed}`;
  window.location.href = url;
}

/* =======================
        BUTTON ACTIONS
======================= */
async function handleDrop() {
  sndClick.currentTime = 0;
    sndClick.play().catch(()=>{});

  if (cashedOut || finished) {
    showToast("Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ù†ØªÙ‡ÙŠØ©");
    return;
  }
  dropBtn.disabled = true;
  const data = await apiDrop();
  if (!data) return;
  currentMultiplier = data.multiplier;
  launchBallForMultiplier(currentMultiplier);
}
function handleCashout() {
  if (cashedOut) {
    goToResult();
    return;
  }
  apiCashout();
}

/* =======================
        SOUNDS
======================= */

// 1) ØµÙˆØª Ø²Ø± "Ù†Ø²Ù„ Ø§Ù„ÙƒØ±Ø©"
const sndClick = new Audio("/sounds/click.mp3");

// 2) ØµÙˆØª Ø§ØµØ·Ø¯Ø§Ù… Ø§Ù„ÙƒØ±Ø© Ø¨Ø§Ù„Ù…Ø³Ù…Ø§Ø±
const sndPin = new Audio("/sounds/pin_hit.mp3");

// 3) Ø£ØµÙˆØ§Øª Ø­Ø³Ø¨ Ø®Ø§Ù†Ø© Ø§Ù„Ù…Ø¶Ø§Ø¹Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
const slotSounds = {
    0:    new Audio("/sounds/slot_0.mp3"),
    1:    new Audio("/sounds/slot_1.mp3"),
    2:    new Audio("/sounds/slot_2.mp3"),
    5:    new Audio("/sounds/slot_5.mp3"),
    10:   new Audio("/sounds/slot_10.mp3"),
    25:   new Audio("/sounds/slot_25.mp3"),
    50:   new Audio("/sounds/slot_50.mp3"),
    100:  new Audio("/sounds/slot_100.mp3"),
    1000: new Audio("/sounds/slot_1000.mp3")
};

// 4) ØµÙˆØª Ø§Ù„ÙƒØ§Ø´ Ø¢ÙˆØª
const sndCashout = new Audio("/sounds/cashout.mp3");

/* =======================
       MATTER.JS SETUP
======================= */
const { Engine, Render, Runner, Bodies, Composite, World, Events } = Matter;

const engine = Engine.create();
const world = engine.world;

const container = document.getElementById("plinko-container");
const width = container.clientWidth;
const height = container.clientHeight;

const render = Render.create({
  element: container,
  engine: engine,
  options: {
    width,
    height,
    background: "#020617",
    wireframes: false,
    pixelRatio: window.devicePixelRatio || 1
  }
});

Render.run(render);
const runner = Runner.create();
Runner.run(runner, engine);

// Ø­Ø¯ÙˆØ¯
const wallThickness = 30;
const ground = Bodies.rectangle(width/2, height+10, width+60, 40, { isStatic: true });
const leftWall = Bodies.rectangle(-wallThickness/2, height/2, wallThickness, height*2, { isStatic: true });
const rightWall = Bodies.rectangle(width+wallThickness/2, height/2, wallThickness, height*2, { isStatic: true });

World.add(world, [ground, leftWall, rightWall]);

// Ù…Ø³Ø§Ù…ÙŠØ±
const pegRadius = 4;
const rows = 10;
const cols = 13;
const pegSpacingX = width / (cols + 1);
const pegSpacingY = (height - 120) / (rows + 1);

for (let row = 0; row < rows; row++) {
  for (let col = 0; col < cols; col++) {
    const offsetX = (row % 2 === 0) ? 0 : pegSpacingX / 2;
    const x = (col + 1) * pegSpacingX + offsetX;
    const y = (row + 1) * pegSpacingY + 30;
    const peg = Bodies.circle(x, y, pegRadius, {
      isStatic: true,
      label: "peg",
      render: { fillStyle: "#e5e7eb" }
    });
    World.add(world, peg);
  }
}

// ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø®Ø§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ (invisible walls Ø¨ÙŠÙ† Ø§Ù„Ù€ bins)
const binCount = BIN_MULTIPLIERS.length;
const binWidth = width / binCount;
for (let i = 0; i <= binCount; i++) {
  const x = i * binWidth;
  const wall = Bodies.rectangle(
    x,
    height - 25,
    4,
    70,
    { isStatic: true, render: { visible: false } }
  );
  World.add(world, wall);
}

// Ø§Ù„ÙƒØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
let currentBall = null;
let currentMultiplier = 0;
let landedHandled = false;

// Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ÙƒØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù€ multiplier
function launchBallForMultiplier(mult) {
  playDrop();

  const indexes = [];
  BIN_MULTIPLIERS.forEach((m, i) => {
    if (m === mult) indexes.push(i);
  });
  let targetIndex = 0;
  if (indexes.length > 0) {
    targetIndex = indexes[Math.floor(Math.random() * indexes.length)];
  } else {
    targetIndex = Math.floor(binCount / 2);
  }

  const centerX = (targetIndex + 0.5) * binWidth;

  if (currentBall) {
    Composite.remove(world, currentBall);
    currentBall = null;
  }
  landedHandled = false;

  currentBall = Bodies.circle(centerX, 10, 8, {
    restitution: 0.45,
    friction: 0.02,
    density: 0.002,
    render: {
      fillStyle: "#22c55e"
    }
  });
  World.add(world, currentBall);

  // Ø¥Ø¹Ø·Ø§Ø¡ Ø¯ÙØ¹Ø© Ø¨Ø³ÙŠØ·Ø©
  Matter.Body.setVelocity(currentBall, { x: (Math.random() - 0.5) * 1.2, y: 0 });
}

// Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØµÙˆÙ„ Ø§Ù„ÙƒØ±Ø© Ù„Ù„Ø£Ø³ÙÙ„ Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ÙˆÙØªØ­ Ø²Ø± Ø§Ù„Ø¥Ø³Ù‚Ø§Ø·
Events.on(engine, "afterUpdate", () => {
  if (!currentBall) return;

  if (!landedHandled && currentBall.position.y > height - 40) {
      landedHandled = true;

      const m = currentMultiplier;

      // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¶Ø§Ø¹Ù
      if (slotSounds[m]) {
          slotSounds[m].currentTime = 0;
          slotSounds[m].play().catch(()=>{});
      }

      showToast(`Ø§Ù„Ù…Ø¶Ø§Ø¹ÙÙ: ${m}x`, 1800);

      setTimeout(() => {
          dropBtn.disabled = false;
      }, 400);
  }

  if (currentBall.position.y > height + 80) {
    Composite.remove(world, currentBall);
    currentBall = null;
  }
});
Events.on(engine, "collisionStart", (event) => {
    for (let pair of event.pairs) {
        const { bodyA, bodyB } = pair;

        if (bodyA.label === "peg" || bodyB.label === "peg") {
            sndPin.currentTime = 0;
            sndPin.play().catch(()=>{});
        }
    }
});

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©
initSession();
</script>
</body>
</html>
